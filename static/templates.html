<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ¿ç®¡ç† - ScriptGateway</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; margin-bottom: 10px; }
        .header-btn { padding: 8px 16px; border: 1px solid #d9d9d9; background: #fff; color: #333; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .header-btn:hover { background: #f0f0f0; border-color: #1890ff; color: #1890ff; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: white; border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 14px; }
        .tab.active { background: #1890ff; color: white; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .editor-container { margin-top: 15px; }
        textarea { width: 100%; height: 400px; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; padding: 12px; border: 1px solid #d9d9d9; border-radius: 4px; resize: vertical; }
        .btn-group { margin-top: 15px; display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #1890ff; color: white; border-color: #1890ff; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-success { background: #52c41a; color: white; border-color: #52c41a; }
        .btn-success:hover { background: #73d13d; }
        .btn-warning { background: #faad14; color: white; border-color: #faad14; }
        .btn-warning:hover { background: #ffc53d; }
        .help-text { font-size: 12px; color: #8c8c8c; margin-top: 8px; }
        
        /* å®šåˆ¶åŒ–ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .confirm-dialog {
            background: white;
            border-radius: 8px;
            padding: 0;
            min-width: 400px;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: confirmFadeIn 0.2s ease-out;
        }
        @keyframes confirmFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .confirm-header {
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .confirm-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        .confirm-body {
            padding: 20px;
            color: #666;
            line-height: 1.5;
        }
        .confirm-footer {
            padding: 10px 20px 20px 20px;
            text-align: right;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .confirm-btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            border: 1px solid #d9d9d9;
            background: #fff;
            color: #333;
        }
        .confirm-btn:hover {
            background: #f0f0f0;
        }
        .confirm-btn.confirm {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        .confirm-btn.confirm:hover {
            background: #40a9ff;
        }
        .confirm-btn.danger {
            background: #ff4d4f;
            color: white;
            border-color: #ff4d4f;
        }
        .confirm-btn.danger:hover {
            background: #ff7875;
        }
        .confirm-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 20px;
        }
        .confirm-warning { color: #faad14; }
        .confirm-error { color: #ff4d4f; }
        .confirm-info { color: #1890ff; }
        .confirm-success { color: #52c41a; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ æ¨¡æ¿ç®¡ç†</h1>
        <a href="/" class="header-btn">â† è¿”å›é¦–é¡µ</a>
    </div>

    <div class="tabs">
        <button class="tab active" data-type="python" onclick="switchTab('python')">Python æ¨¡æ¿</button>
        <button class="tab" data-type="js" onclick="switchTab('js')">JavaScript æ¨¡æ¿</button>
    </div>

    <div class="card">
        <h3 id="templateTitle">Python è„šæœ¬æ¨¡æ¿</h3>
        <div class="help-text">ä¿®æ”¹åç‚¹å‡»"ä¿å­˜"ç”Ÿæ•ˆï¼Œæ–°å»ºè„šæœ¬æ—¶å°†ä½¿ç”¨æ­¤æ¨¡æ¿ã€‚</div>
        
        <div class="editor-container">
            <textarea id="templateEditor" placeholder="åŠ è½½ä¸­..."></textarea>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="saveTemplate()">ğŸ’¾ ä¿å­˜æ¨¡æ¿</button>
            <button class="btn btn-success" onclick="downloadTemplate()">ğŸ“¥ ä¸‹è½½æ¨¡æ¿</button>
            <button class="btn btn-warning" onclick="resetTemplate()">ğŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
        </div>
    </div>

    <script>
        let currentType = 'python';

        async function switchTab(type) {
            currentType = type;
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.type === type);
            });
            document.getElementById('templateTitle').textContent = 
                type === 'python' ? 'Python è„šæœ¬æ¨¡æ¿' : 'JavaScript è„šæœ¬æ¨¡æ¿';
            await loadTemplate();
        }

        async function loadTemplate() {
            try {
                const res = await fetch(`/api/templates/${currentType}`);
                const data = await res.json();
                document.getElementById('templateEditor').value = data.content || '';
            } catch (err) {
                alert('åŠ è½½æ¨¡æ¿å¤±è´¥: ' + err.message);
            }
        }

        async function saveTemplate() {
            const content = document.getElementById('templateEditor').value;
            if (!content.trim()) {
                alert('æ¨¡æ¿å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            try {
                const res = await fetch(`/api/templates/${currentType}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                if (res.ok) {
                    alert('âœ… æ¨¡æ¿ä¿å­˜æˆåŠŸï¼');
                } else {
                    const data = await res.json();
                    alert('ä¿å­˜å¤±è´¥: ' + (data.error || res.statusText));
                }
            } catch (err) {
                alert('ä¿å­˜å¤±è´¥: ' + err.message);
            }
        }

        async function resetTemplate() {
            if (!await confirm('ç¡®å®šé‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿ï¼Ÿå½“å‰ä¿®æ”¹å°†ä¸¢å¤±ï¼', { 
                type: 'warning', 
                confirmButtonType: 'danger',
                confirmText: 'é‡ç½®',
                title: 'é‡ç½®æ¨¡æ¿'
            })) return;
            try {
                const res = await fetch(`/api/templates/${currentType}/reset`, { method: 'POST' });
                if (res.ok) {
                    alert('âœ… æ¨¡æ¿å·²é‡ç½®ä¸ºé»˜è®¤ï¼');
                    await loadTemplate();
                } else {
                    const data = await res.json();
                    alert('é‡ç½®å¤±è´¥: ' + (data.error || res.statusText));
                }
            } catch (err) {
                alert('é‡ç½®å¤±è´¥: ' + err.message);
            }
        }

        async function downloadTemplate() {
            const content = document.getElementById('templateEditor').value;
            const ext = currentType === 'python' ? 'py' : 'js';
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `template.${ext}`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // åˆå§‹åŠ è½½
        loadTemplate();
    </script>

    <!-- å®šåˆ¶åŒ–ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="confirmOverlay" class="confirm-overlay">
        <div class="confirm-dialog">
            <div class="confirm-header">
                <h4 class="confirm-title" id="confirmTitle">ç¡®è®¤æ“ä½œ</h4>
            </div>
            <div class="confirm-body" id="confirmBody">
                ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ
            </div>
            <div class="confirm-footer">
                <button class="confirm-btn" id="confirmCancel">å–æ¶ˆ</button>
                <button class="confirm-btn confirm" id="confirmOk">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // å®šåˆ¶åŒ–ç¡®è®¤å¯¹è¯æ¡†
        class ConfirmDialog {
            constructor() {
                this.overlay = document.getElementById('confirmOverlay');
                this.title = document.getElementById('confirmTitle');
                this.body = document.getElementById('confirmBody');
                this.cancelBtn = document.getElementById('confirmCancel');
                this.okBtn = document.getElementById('confirmOk');
                this.currentResolve = null;
                
                this.initEvents();
            }
            
            initEvents() {
                this.cancelBtn.addEventListener('click', () => this.hide(false));
                this.okBtn.addEventListener('click', () => this.hide(true));
                this.overlay.addEventListener('click', (e) => {
                    if (e.target === this.overlay) {
                        this.hide(false);
                    }
                });
                
                // ESC é”®å…³é—­
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.overlay.style.display === 'flex') {
                        this.hide(false);
                    }
                });
            }
            
            show(options = {}) {
                const {
                    title = 'ç¡®è®¤æ“ä½œ',
                    message = 'ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ',
                    type = 'warning', // warning, error, info, success
                    confirmText = 'ç¡®å®š',
                    cancelText = 'å–æ¶ˆ',
                    confirmButtonType = 'confirm' // confirm, danger
                } = options;
                
                // è®¾ç½®å›¾æ ‡
                let icon = '';
                switch (type) {
                    case 'warning': icon = '<span class="confirm-icon confirm-warning">âš ï¸</span>'; break;
                    case 'error': icon = '<span class="confirm-icon confirm-error">âŒ</span>'; break;
                    case 'info': icon = '<span class="confirm-icon confirm-info">â„¹ï¸</span>'; break;
                    case 'success': icon = '<span class="confirm-icon confirm-success">âœ…</span>'; break;
                }
                
                this.title.innerHTML = icon + title;
                this.body.innerHTML = message.replace(/\n/g, '<br>');
                this.cancelBtn.textContent = cancelText;
                this.okBtn.textContent = confirmText;
                
                // è®¾ç½®ç¡®è®¤æŒ‰é’®ç±»å‹
                this.okBtn.className = `confirm-btn ${confirmButtonType}`;
                
                this.overlay.style.display = 'flex';
                
                return new Promise((resolve) => {
                    this.currentResolve = resolve;
                });
            }
            
            hide(confirmed) {
                this.overlay.style.display = 'none';
                if (this.currentResolve) {
                    this.currentResolve(confirmed);
                    this.currentResolve = null;
                }
            }
        }
        
        // åˆ›å»ºå…¨å±€ç¡®è®¤å¯¹è¯æ¡†å®ä¾‹
        window.customConfirm = new ConfirmDialog();
        
        // æ›¿æ¢å…¨å±€ confirm å‡½æ•°
        window.originalConfirm = window.confirm;
        window.confirm = function(message, options = {}) {
            return window.customConfirm.show({
                message: message,
                type: options.type || 'warning',
                confirmText: options.confirmText || 'ç¡®å®š',
                cancelText: options.cancelText || 'å–æ¶ˆ',
                confirmButtonType: options.confirmButtonType || 'confirm'
            });
        };
    </script>
</body>
</html>
